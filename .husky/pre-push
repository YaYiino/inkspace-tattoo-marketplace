#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks..."

# Get current branch
current_branch=$(git branch --show-current)

# Skip checks for certain branches
if [ "$current_branch" = "main" ] || [ "$current_branch" = "develop" ]; then
  echo "âš ï¸  Pushing to protected branch: $current_branch"
  echo "   Make sure this is intended and approved!"
  
  # Could add additional checks here for main/develop
  # For now, just warn but allow
fi

# Run full test suite before pushing
echo "ğŸ§ª Running full test suite..."
npm run test || {
  echo "âŒ Tests failed! Cannot push."
  echo "ğŸ’¡ Fix failing tests before pushing"
  exit 1
}

# Run type check
echo "ğŸ” Running type check..."
npm run type-check || {
  echo "âŒ Type check failed! Cannot push."
  exit 1
}

# Run linter on all files
echo "ğŸ” Running full lint check..."
npm run lint || {
  echo "âŒ Lint check failed! Cannot push."
  echo "ğŸ’¡ Run 'npm run lint:fix' to auto-fix issues"
  exit 1
}

# Build check
echo "ğŸ—ï¸  Running build check..."
npm run build || {
  echo "âŒ Build failed! Cannot push."
  echo "ğŸ’¡ Fix build errors before pushing"
  exit 1
}

# Security audit
echo "ğŸ›¡ï¸  Running security audit..."
npm audit --audit-level moderate || {
  echo "âš ï¸  Security vulnerabilities found!"
  echo "ğŸ’¡ Run 'npm audit fix' to resolve issues"
  echo "   Or 'npm audit' to see details"
  # Don't block push, but warn
}

# Check for large files
echo "ğŸ“¦ Checking for large files..."
large_files=$(git ls-files | xargs ls -l | awk '$5 > 5242880 {print $9, $5}')
if [ -n "$large_files" ]; then
  echo "âš ï¸  Large files detected (>5MB):"
  echo "$large_files"
  echo "ğŸ’¡ Consider using Git LFS for large assets"
  # Don't block push, but warn
fi

# Check if pushing to main/develop without PR
if [ "$current_branch" = "main" ] && [ -z "$GITHUB_ACTIONS" ]; then
  echo "âŒ Direct push to main branch is not allowed!"
  echo "ğŸ’¡ Create a pull request instead"
  exit 1
fi

if [ "$current_branch" = "develop" ] && [ -z "$GITHUB_ACTIONS" ]; then
  echo "âš ï¸  Pushing directly to develop branch"
  echo "ğŸ’¡ Consider using a feature branch and PR"
  # Allow but warn
fi

# Check branch naming convention for feature branches
if echo "$current_branch" | grep -q "^feature/"; then
  if ! echo "$current_branch" | grep -qE "^feature/[a-z0-9-]+$"; then
    echo "âš ï¸  Branch name doesn't follow convention"
    echo "   Current: $current_branch"
    echo "   Expected: feature/kebab-case-name"
  fi
fi

echo "âœ… Pre-push checks passed!"
echo "ğŸš€ Ready to push to $current_branch!"